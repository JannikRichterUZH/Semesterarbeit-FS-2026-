---
title: "Semesterarbeit"
format: html
editor: visual
---

### ESS Daten einlesen und Variablen auswählen

```{r}
df_ess_full_3 <- read_csv("Daten/ESS10e03_3.csv")
df_ess_full_2 <- read_csv("Daten/ESS10SCe03_2.csv")

df_ess_joined <- bind_rows(df_ess_full_2, df_ess_full_3)


df_ess <- df_ess_joined %>% 
  select(cntry, trstprl, trstprt, trstep, agea, eduyrs, anweight) %>% 
  filter(! cntry %in% c("AL", "BG","CY","GE","HR","IL","LV",
                         "ME","MK","PT","RS","RU","TR","UA","XK")) %>% 
  mutate(
    cntry = case_match(
      cntry,
      "AT" ~ "Austria",
      "BE" ~ "Belgium",
      "CH" ~ "Switzerland",
      "CZ" ~ "Czech Republic",
      "DE" ~ "Germany",
      "DK" ~ "Denmark",
      "EE" ~ "Estonia",
      "ES" ~ "Spain",
      "FI" ~ "Finland",
      "FR" ~ "France",
      "GB" ~ "United Kingdom",
      "GR" ~ "Greece",
      "HU" ~ "Hungary",
      "IE" ~ "Ireland",
      "IS" ~ "Iceland",
      "IT" ~ "Italy",
      "LT" ~ "Lithuania",
      "LU" ~ "Luxembourg",
      "NL" ~ "Netherlands",
      "NO" ~ "Norway",
      "PL" ~ "Poland",
      "RO" ~ "Romania",
      "SE" ~ "Sweden",
      "SI" ~ "Slovenia",
      "SK" ~ "Slovakia"),
    trstprl = case_match(
      trstprl,
      c(77, 88, 99) ~ NA,
      .default = trstprl
    ),
    trstprt = case_match(
      trstprt,
      c(77, 88, 99) ~ NA,
      .default = trstprt
    ),
    trstep = case_match(
      trstep,
      c(77, 88, 99) ~ NA,
      .default = trstep
    ),
    agea = case_match(
      agea,
      999 ~ NA,
      .default = agea
    ),
    eduyrs = case_match(
      eduyrs,
      c(77, 88, 99) ~ NA,
      .default = eduyrs
    )
  ) %>% 
  drop_na()
 
table(df_ess$cntry, useNA = "ifany")
```

### CPDS Daten einlesen und Variablen auswählen

```{r}
df_cpds_full <- read_dta("Daten/CPDS_1960-2023_Update_2025.dta") 

df_cpds_filtered <- df_cpds_full %>% 
  select(country, year, postfisc_gini) %>% 
  filter(! country %in% c("Australia","Canada","USA",
                          "Denmark","Luxembourg","Romania", "Japan")) %>% 
  rename(cntry = country) %>% 
  drop_na()

df_cpds <- df_cpds_filtered %>%
  filter(!is.na(postfisc_gini)) %>%
  group_by(cntry) %>%
  mutate(year_diff = abs(year - 2021)) %>%
  slice_min(year_diff, n = 1) %>%
  ungroup()

table(df_cpds$cntry, useNA = "ifany")
```

### ESS und CPDS zusammenfügen

```{r}
df_joined_ess_cpds <- df_ess %>%
  left_join(df_cpds, by = "cntry") %>% 
  mutate(cntry = factor(cntry))

table(df_joined_ess_cpds$cntry, useNA = "ifany")
glimpse(df_joined_ess_cpds)
```

### Modelle schätzen mit Interaktion

```{r}
library(lme4)
library(modelsummary)

lm_trstprl_int <- lmer(
  trstprl ~ postfisc_gini * year_diff + agea + eduyrs + (1 | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

lm_trstprt_int <- lmer(
  trstprt ~ postfisc_gini * year_diff + agea + eduyrs + (1 | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

lm_trstep_int <- lmer(
  trstep ~ postfisc_gini * year_diff + agea + eduyrs + (1 | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

stargazer::stargazer(type = "text", c(lm_trstprl_int, lm_trstprt_int, lm_trstep_int))
```

### Modelle schätzen ohne Interaktion → Endmodell

```{r}
lm_trstprl <- lmer(
  trstprl ~ postfisc_gini + agea + eduyrs + (1 | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

lm_trstprt <- lmer(
  trstprt ~ postfisc_gini + agea + eduyrs + (1 | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

lm_trstep <- lmer(
  trstep ~ postfisc_gini + agea + eduyrs + (1 | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

stargazer::stargazer(type = "text", c(lm_trstprl, lm_trstprt, lm_trstep))
```

#### Modell exportieren

```{r}
library(modelsummary)
library(tinytex)
modelsummary(
  list(
    "Vertrauen in das\nNationale Parlament" = lm_trstprl,
    "Vertrauen in\nPolitische Parteien"  = lm_trstprt,
    "Vertrauen in das\nEuropäische Parlament" = lm_trstep
  ),
  stars = TRUE,
  statistic = "conf.int",
  output = "model_overview_basismodell.html"
)

pagedown::chrome_print("model_overview_basismodell.html")
```

### Modelle schätzen mit **random slope für Ungleichheit**

```{r}
lm_trstprl_rs <- lmer(
  trstprl ~ postfisc_gini + agea + eduyrs + (1 + postfisc_gini | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

lm_trstprt_rs <- lmer(
  trstprt ~ postfisc_gini + agea + eduyrs + (1 + postfisc_gini | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

lm_trstep_rs <- lmer(
  trstep ~ postfisc_gini + agea + eduyrs + (1 + postfisc_gini | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

stargazer::stargazer(type = "text", c(lm_trstprl_rs, lm_trstprt_rs, lm_trstep_rs))
```

### Modelle schätzen ohne Kontrollvariablen

```{r}
lm_trstprl_woc <- lmer(
  trstprl ~ postfisc_gini + (1 | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

lm_trstprt_woc <- lmer(
  trstprt ~ postfisc_gini + (1 | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

lm_trstep_woc <- lmer(
  trstep ~ postfisc_gini + (1 | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

stargazer::stargazer(type = "text", c(lm_trstprl_woc, lm_trstprt_woc, lm_trstep_woc))
```

### Nullmodelle (intercept-only)

```{r}
lm_trstprl_nl <- lmer(
  trstprl ~ 1 + (1 | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

lm_trstprt_nl <- lmer(
  trstprt ~ 1 + (1 | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

lm_trstep_nl <- lmer(
  trstep ~ 1 + (1 | cntry),
  data = df_joined_ess_cpds,
  weights = anweight
)

stargazer::stargazer(type = "text", c(lm_trstprl_nl, lm_trstprt_nl, lm_trstep_nl))

library(performance)
icc(lm_trstprl_nl)
icc(lm_trstprt_nl)
icc(lm_trstep_nl)
```

### Modelle Vergleich

```{r}
# Vertrauen in das Parlament des eigenen Landes
stargazer::stargazer(type = "text", c(lm_trstprl, lm_trstprl_int, 
                                      lm_trstprl_woc, lm_trstprl_rs))
icc(lm_trstprl, lm_trstprl_int, lm_trstprl_woc)

# Vertrauen in politische Parteien
stargazer::stargazer(type = "text", c(lm_trstprt, lm_trstprt_int, 
                                      lm_trstprt_woc, lm_trstprt_rs))

# Vertrauen in das Europäische Parlament
stargazer::stargazer(type = "text", c(lm_trstep, lm_trstep_int, 
                                      lm_trstep_woc, lm_trstep_rs))
```

### Modelle Gütevergleich

```{r}
# Vertrauen in das Parlament des eigenen Landes
AIC(lm_trstprl, lm_trstprl_int, lm_trstprl_woc, lm_trstprl_rs)
BIC(lm_trstprl, lm_trstprl_int, lm_trstprl_woc, lm_trstprl_rs)

# Vertrauen in politische Parteien
AIC(lm_trstprt, lm_trstprt_int, lm_trstprt_woc, lm_trstprt_rs)
BIC(lm_trstprt, lm_trstprt_int, lm_trstprt_woc, lm_trstprt_rs)

# Vertrauen in das Europäische Parlament
AIC(lm_trstep, lm_trstep_int, lm_trstep_woc, lm_trstep_rs)
BIC(lm_trstep, lm_trstep_int, lm_trstep_woc, lm_trstep_rs)
```

### Graphische Darstellung

```{r}
library(broom.mixed)
library(dplyr)
library(ggplot2)

tidy_ep <- tidy(lm_trstep, conf.int = TRUE) %>%
  mutate(DV = "Vertrauen in das\nEuropäische Parlament")

tidy_prl <- tidy(lm_trstprl, conf.int = TRUE) %>%
  mutate(DV = "Vertrauen in das\nNationale Parlament")

tidy_prt <- tidy(lm_trstprt, conf.int = TRUE) %>%
  mutate(DV = "Vertrauen in\nPolitische Parteien")

plot_data <- bind_rows(tidy_ep, tidy_prl, tidy_prt) %>%
  filter(term %in% c("postfisc_gini", "eduyrs", "agea"))

plot_data <- plot_data %>%
  mutate(
    term = recode(term,
                  "postfisc_gini" = "Einkommens-\nungleichheit\n(Gini)",
                  "eduyrs" = "Bildungsjahre",
                  "agea" = "Alter")
  ) 

plot_data <- plot_data %>%
  mutate(
    DV = factor(
      DV,
      levels = c(
        "Vertrauen in das\nNationale Parlament",
        "Vertrauen in\nPolitische Parteien",
        "Vertrauen in das\nEuropäische Parlament"
      )
    )
  )

plot_final <- ggplot(plot_data, aes(x = estimate, y = term)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey40") +
  geom_point(size = 2) +
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high), width = 0.2) +
  facet_wrap(~ DV) +
  scale_x_continuous(limits = c(-0.25, 0.25),
                     breaks = seq(-0.2, 0.2, by = 0.1)) + 
  labs(
    x = "Geschätzter Effekt (95%-Konfidenzintervall)",
    y = NULL
  ) +
  theme_minimal(base_size = 20) +
  theme(
    axis.text.y = element_text(size = 15),
    axis.text.x = element_text(size = 13),
    axis.title.x = element_text(size = 15, face = "bold", vjust = -1),
    strip.text = element_text(size = 16, face = "bold", vjust = 2),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10, unit = "mm"),
    panel.grid.minor = element_blank(),
    panel.spacing = unit(1, "lines")
  )

plot_final
```

#### ICC plot

```{r}
library(dplyr)
library(tidyr)

icc_prl <- as.numeric(icc(lm_trstprl_nl)$ICC_adjusted[1])
icc_prt <- as.numeric(icc(lm_trstprt_nl)$ICC_adjusted[1])
icc_ep  <- as.numeric(icc(lm_trstep_nl)$ICC_adjusted[1])


icc_data <- tibble(
  Institution = c(
    "Nationales\nParlament",
    "Politische\nParteien",
    "Europäisches\nParlament"
  ),
  Länderanteil = c(icc_prl, icc_prt, icc_ep)
) %>%
  mutate(Individualanteil = 1 - Länderanteil) %>%
  pivot_longer(
    cols = c(Länderanteil, Individualanteil),
    names_to = "Ebene",
    values_to = "Varianzanteil"
  )



icc_plot <- ggplot(
  icc_data,
  aes(x = Institution, y = Varianzanteil, fill = Ebene)
) +
  geom_col(width = 0.6) +
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    limits = c(0, 1)
  ) +
  scale_fill_manual(
    values = c(
      "Länderanteil" = "grey40",
      "Individualanteil" = "grey80"
    ),
    labels = c(
      "Individualanteil" = "Individuelle Ebene",
      "Länderanteil" = "Länderebene"
    )
  ) +
  labs(
    y = "Anteil der Varianz",
    x = NULL,
    fill = NULL,
    title = "Varianzanteile im politischen Vertrauen (ICC)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(size = 14),
    axis.text.y = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )

icc_plot
```

#### Plots exportieren

```{r}
ggsave(
  filename = "koeffizientenplot_mehrebenenmodell.pdf",
  plot = plot_final,
  width = 28,
  height = 12,
  units = "cm"
)

ggsave(
  filename = "icc_plot.pdf",
  plot = icc_plot,
  width = 20,
  height = 10,
  units = "cm"
)
```
